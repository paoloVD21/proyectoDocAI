{% extends 'base.html' %}
{% load static %}
{% load template_filters %}

{% block title %}{{ artefacto.titulo }} | Artefacto{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/artefactos.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-1">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-primary">{{ artefacto.titulo }}</h2>
            <span class="badge bg-info text-dark">{{ artefacto.get_tipo_display }}</span>
            <p class="text-muted mt-2">Proyecto: <strong>{{ artefacto.proyecto.nombre }}</strong></p>
        </div>
        <div class="d-flex">
            <a href="{% url 'detalle_proyecto' artefacto.proyecto.id %}" class="btn btn-outline-success me-2">← Regresar</a>
            <a href="{% url 'editar_artefacto' artefacto.id %}" class="btn btn-outline-warning me-2">✏️ Editar</a>
            <form method="post" action="{% url 'eliminar_artefacto' artefacto.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger me-2">🗑️ Eliminar</button>
            </form>
        </div>
    </div>

    {% if artefacto.titulo == "Historia de Usuario" %}
    <!-- Bloque de Historias de Usuario -->
    <div class="card mt-3 border-info">
        <div class="card-body">
            <h5 class="card-header bg-info text-white mb-3">Historias de Usuario</h5>
            <div id="historias-container" class="p-4 bg-light rounded shadow-sm">
                <div class="historias-lista" id="historias-lista">
                    {% for historia in artefacto.contenido|parse_historias %}
                    <div class="historia-item card mb-3" draggable="true" data-historia-id="{{ forloop.counter }}">
                        <div class="card-body">
                            <h6 class="card-title text-primary mb-2">Historia de Usuario #{{ forloop.counter }}</h6>
                            <p class="card-text"><strong>Como:</strong> {{ historia.como }}</p>
                            <p class="card-text"><strong>Quiero:</strong> {{ historia.quiero }}</p>
                            <p class="card-text"><strong>Para:</strong> {{ historia.para }}</p>
                            {% if historia.criterios %}
                            <div class="mt-2">
                                <strong>Criterios de Aceptación:</strong>
                                <ul class="list-group list-group-flush mt-1">
                                    {% for criterio in historia.criterios %}
                                    <li class="list-group-item bg-light">{{ criterio }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if artefacto.titulo in "Diagrama de flujo Diagrama de clases Diagrama de Entidad-Relacion Diagrama de secuencia Diagrama de estado Diagrama de C4-contexto Diagrama de C4-contenedor Diagrama de C4-implementación" %}
    <div class="card p-3 my-4 shadow border-info">
        <h5 class="text-center text-white bg-info">🧩 Diagrama generado</h5>

        <div class="text-end mb-3">
            <button onclick="descargardiagrama('svg')" class="btn btn-outline-success btn-sm me-2">⬇️ SVG</button>
            <button onclick="descargardiagrama('jpg')" class="btn btn-outline-success btn-sm me-2">⬇️ JPG</button>
            <a href="{% url 'descargar_diagrama' artefacto.id %}" class="btn btn-outline-success btn-sm">⬇️ MMD</a>
        </div>

        <div class="mermaid" id="mermaid-container">
          {{ artefacto.contenido|safe }}
        </div>
        <script id="mermaid-code" type="text/plain">
          {{ artefacto.contenido|safe }}
        </script>

    </div>
    {% endif %}

    {% if artefacto.titulo == "Requisitos" %}
    <!-- Bloque para Requisitos -->
    <div class="card mt-3 border-info">
        <div class="card-body">
            <h5 class="card-header bg-info text-white mb-3">Historias de Usuario y sus Requisitos</h5>
            <div class="p-4 bg-light rounded shadow-sm">
                {% if historia_usuario %}
                    {% for historia in historia_usuario.contenido|parse_historias %}
                    <div class="card mb-4 border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">Historia de Usuario #{{ forloop.counter }}</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Como:</strong> {{ historia.como }}</p>
                            <p><strong>Quiero:</strong> {{ historia.quiero }}</p>
                            <p><strong>Para:</strong> {{ historia.para }}</p>
                            
                            <div class="mt-3 bg-light p-3 rounded">
                                <h6 class="text-primary mb-2">Requisitos Funcionales Asociados:</h6>
                                {% with requisitos_historia=artefacto.contenido|filter_requisitos:forloop.counter %}
                                    {% if requisitos_historia %}
                                        {% for requisito in requisitos_historia %}
                                        <div class="alert alert-info mb-2">
                                            {{ requisito }}
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted">No se encontraron requisitos específicos para esta historia.</p>
                                    {% endif %}
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-warning">
                        No se encontró la Historia de Usuario asociada.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if artefacto.titulo not in "Historia de Usuario Requisitos Diagrama de flujo Diagrama de clases Diagrama de Entidad-Relacion Diagrama de secuencia Diagrama de estado Diagrama de C4-contexto Diagrama de C4-contenedor Diagrama de C4-implementación" %}
    <!-- Bloque para otros tipos de artefactos -->
    <div class="card mt-3 border-info">
        <div class="card-body">
            <h5 class="card-header bg-info text-white">Contenido del Artefacto</h5>
            <div class="p-4 bg-light rounded shadow-sm">
                <pre class="fs-6" style="white-space: pre-wrap; line-height: 1.8em;">{{ artefacto.contenido }}</pre>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% block extra_js %}
<script>
  window.DIAGRAMA_INFO = {
    proyecto: "{{ artefacto.proyecto.nombre|slugify }}",
    titulo: "{{ artefacto.titulo|slugify }}",
    fecha: "{{ artefacto.creado|date:'Y-m-d' }}"
  };
</script>
<script type="module" src="{% static 'js/diagramas.js' %}"></script>
<script src="{% static 'js/artefactos.js' %}"></script>
{% endblock %}
{% endblock %}